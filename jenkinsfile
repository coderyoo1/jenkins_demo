pipeline {
    agent any
    
    environment {
        // 你自己的镜像仓库地址
        REGISTRY       = "registry.cn-hangzhou.aliyuncs.com/jingansi"
        // 镜像名称
        IMAGE_NAME     = "jenkins-demo"
        // 使用 Git Tag + Git Commit(前 4 位) + YYYYMMDD 作为镜像标签
        IMAGE_TAG      = "${GIT_TAG ? GIT_TAG : 'latest'}-${GIT_COMMIT.substring(0,4)}-$(date +%Y%m%d)"
        // 凭据 ID（在 Jenkins -> Credentials 配置）
        DOCKER_CRED_ID = "public-aliyun-registry"
        // 构建平台
        BUILD_PLATFORM = "linux/amd64"
    }

    stages {
        stage('Docker Login') {
            steps {
                script {
                    withCredentials([usernamePassword(
                        credentialsId: "${DOCKER_CRED_ID}",
                        usernameVariable: 'DOCKER_USER',
                        passwordVariable: 'DOCKER_PASS'
                    )]) {
                        sh "echo ${DOCKER_PASS} | docker login ${REGISTRY} -u ${DOCKER_USER} --password-stdin"
                    }
                }
            }
        }

        stage('Build and Push') {
            steps {
                script {
                    sh """
                        echo "Building and Pushing Docker Image: ${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG}"
                        echo ""

                        docker buildx build \
                            --platform ${BUILD_PLATFORM} \
                            -t ${REGISTRY}/${IMAGE_NAME}:${IMAGE_TAG} \
                            --push \
                            .
                    """
                }
            }
        }
    }

    post {
        always {
            echo 'always...'
        }
        success {
            echo 'success...'
        }
        failure {
            echo 'failure...'
        }
        unstable {
            echo 'unstable...'
        }
        changed {
            echo 'changed...'
        }
    }
}